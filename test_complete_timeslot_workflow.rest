### Complete Timeslot Conflict Testing with Seeded Manager Account
### This tests the full workflow using proper account creation methods

@baseUrl = https://localhost:8443/api

# Variables to store tokens and IDs
@managerToken = 
@providerToken = 
@petOwnerToken = 
@serviceId = 
@petId = 
@bookingId = 

### 1. Login as Manager (using seeded account)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "admin@petcare.com",
    "password": "SuperSecureAdminPass123!"
}

### 2. Register Service Provider
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
    "name": "Test Provider",
    "email": "provider@testapi.com",
    "password": "TestPassword123!",
    "confirmPassword": "TestPassword123!",
    "gender": "Male",
    "role": "Service provider",
    "businessName": "Test Pet Services API",
    "phone": "+84987654321",
    "description": "Professional pet care services for testing",
    "address": "456 Business Avenue, Test City",
    "website": "https://testpetservicesapi.com"
}

### 3. Register Pet Owner
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
    "name": "Test Pet Owner",
    "email": "petowner@testapi.com",
    "password": "TestPassword123!",
    "confirmPassword": "TestPassword123!",
    "gender": "Female",
    "role": "Pet owner",
    "phone": "+84901234567",
    "city": "Test City",
    "address": "123 Pet Street, Test City"
}

### 4. Login as Service Provider
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "provider@testapi.com",
    "password": "TestPassword123!"
}

### 5. Login as Pet Owner
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "petowner@testapi.com",
    "password": "TestPassword123!"
}

### 6. Get Service Types (for service creation)
GET {{baseUrl}}/services/types
Authorization: Bearer {{providerToken}}

### 7. Create Service Type (as manager if needed)
POST {{baseUrl}}/services/types
Authorization: Bearer {{managerToken}}
Content-Type: application/json

{
    "type": "Pet Grooming"
}

### 8. Submit Service for Approval (as provider)
POST {{baseUrl}}/services
Authorization: Bearer {{providerToken}}
Content-Type: application/json

{
    "name": "Premium Pet Grooming Service",
    "price": 75,
    "description": "Complete grooming service including bath, cut, nail trimming, and styling",
    "duration": "2 hours",
    "typeid": 1,
    "timeSlots": ["09:00", "10:00", "11:00", "14:00", "15:00", "16:00"]
}

### 9. Get Pending Services (as manager)
GET {{baseUrl}}/services/pending
Authorization: Bearer {{managerToken}}

### 10. Approve Service (as manager) - use actual service ID
POST {{baseUrl}}/services/1/review
Authorization: Bearer {{managerToken}}
Content-Type: application/json

{
    "action": "approve"
}

### 11. Create Pet (as pet owner)
POST {{baseUrl}}/pets
Authorization: Bearer {{petOwnerToken}}
Content-Type: application/json

{
    "name": "Buddy",
    "breed": "Golden Retriever",
    "description": "Friendly and energetic dog",
    "picture": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=",
    "age": 3,
    "dob": "2022-01-15"
}

### 12. Create Booking (as pet owner) - This creates the conflict scenario
POST {{baseUrl}}/bookings
Authorization: Bearer {{petOwnerToken}}
Content-Type: application/json

{
    "serviceId": 1,
    "slot": "10:00",
    "servedate": "2025-06-15",
    "payment_method": "Credit Card",
    "petIds": [1]
}

### 13. Try to Update Service Timeslots - Remove booked slot (SHOULD FAIL with 409 Conflict)
PUT {{baseUrl}}/services/1/update-approved
Authorization: Bearer {{providerToken}}
Content-Type: application/json

{
    "timeSlots": ["09:00", "11:00", "14:00", "15:00", "16:00"]
}

### 14. Update Service Timeslots - Keep booked slot, add new ones (SHOULD SUCCEED)
PUT {{baseUrl}}/services/1/update-approved
Authorization: Bearer {{providerToken}}
Content-Type: application/json

{
    "timeSlots": ["09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"]
}

### 15. Update Only Description (SHOULD SUCCEED)
PUT {{baseUrl}}/services/1/update-approved
Authorization: Bearer {{providerToken}}
Content-Type: application/json

{
    "description": "Updated: Premium pet grooming with conflict-tested availability management"
}

### 16. Get Service Details to Verify Timeslots
GET {{baseUrl}}/services/1
Authorization: Bearer {{providerToken}}

### 17. Get Bookings to Verify Booking Exists
GET {{baseUrl}}/bookings
Authorization: Bearer {{petOwnerToken}}

### 18. Cancel Booking (to test removal after no conflicts)
PUT {{baseUrl}}/bookings/1/cancel
Authorization: Bearer {{petOwnerToken}}

### 19. Now Try Removing the Timeslot Again (SHOULD SUCCEED after cancellation)
PUT {{baseUrl}}/services/1/update-approved
Authorization: Bearer {{providerToken}}
Content-Type: application/json

{
    "timeSlots": ["09:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"]
}

### 20. Verify Final Service State
GET {{baseUrl}}/services/1
Authorization: Bearer {{providerToken}}

### EXPECTED RESULTS:
### Step 13: 409 Conflict - Cannot remove timeslot "10:00" due to active booking
### Step 14: 200 Success - Added new slots while keeping the booked one
### Step 15: 200 Success - Description update works
### Step 19: 200 Success - Can remove slot after booking cancellation

### CONFLICT ERROR SHOULD INCLUDE:
### {
###   "success": false,
###   "error": "Timeslot conflict detected",
###   "message": "Cannot remove timeslots that have active bookings",
###   "conflicts": [
###     {
###       "timeslot": "10:00",
###       "activeBookings": 1,
###       "bookingDetails": [...]
###     }
###   ],
###   "suggestions": [...]
### }
